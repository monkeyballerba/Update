-- Peak Hub - Autojoiner (WebSocket Edition)
-- Joins servers 3M/s and up

local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer

-- âœ… Settings
local MIN_MS = 3000000 -- 3M/s

-- Gui Setup
local gui = Instance.new("ScreenGui")
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 250, 0, 150)
frame.Position = UDim2.new(0.5, -125, 0.5, -75)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
frame.Parent = gui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 15)
UICorner.Parent = frame

-- Title
local title = Instance.new("TextLabel")
title.Text = "Peak Hub - Autojoiner"
title.Size = UDim2.new(1, -40, 0, 40)
title.Position = UDim2.new(0, 5, 0, 5)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = frame

-- Minimize button
local minimize = Instance.new("TextButton")
minimize.Size = UDim2.new(0, 30, 0, 30)
minimize.Position = UDim2.new(1, -35, 0, 5)
minimize.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
minimize.Text = "-"
minimize.TextColor3 = Color3.fromRGB(255, 255, 255)
minimize.Font = Enum.Font.GothamBold
minimize.TextSize = 22
minimize.Parent = frame

local miniCorner = Instance.new("UICorner")
miniCorner.CornerRadius = UDim.new(0, 8)
miniCorner.Parent = minimize

-- Start / Stop button
local button = Instance.new("TextButton")
button.Size = UDim2.new(0.8, 0, 0.3, 0)
button.Position = UDim2.new(0.1, 0, 0.5, 0)
button.BackgroundColor3 = Color3.fromRGB(90, 0, 255)
button.Text = "Start"
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.GothamBold
button.TextSize = 18
button.Parent = frame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 10)
buttonCorner.Parent = button

-- Discord text
local info = Instance.new("TextLabel")
info.Text = "discord.gg/PeakHub"
info.Size = UDim2.new(1, 0, 0, 30)
info.Position = UDim2.new(0, 0, 1, -30)
info.BackgroundTransparency = 1
info.TextColor3 = Color3.fromRGB(180, 180, 180)
info.Font = Enum.Font.Gotham
info.TextSize = 14
info.Parent = frame

-- Restore button setup (hidden initially)
local restore = Instance.new("TextButton")
restore.Size = UDim2.new(0, 60, 0, 30)
restore.Position = UDim2.new(0, 10, 0, 10)
restore.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
restore.Text = "+"
restore.TextColor3 = Color3.fromRGB(255, 255, 255)
restore.Font = Enum.Font.GothamBold
restore.TextSize = 22
restore.Visible = false
restore.Parent = gui

local restoreCorner = Instance.new("UICorner")
restoreCorner.CornerRadius = UDim.new(0, 8)
restoreCorner.Parent = restore

-- Helpers
local function formatMoney(num)
    return string.format("%.1fM", num / 1000000)
end

local function parseMoney(str)
    if not str then return 0 end
    
    -- Remove any non-alphanumeric characters except decimal points and letters
    str = tostring(str):gsub("[^%d%.%a]", "")
    
    local num, suffix = str:match("(%d+%.?%d*)([MK]?)")
    num = tonumber(num)
    if not num then return 0 end

    if suffix == "M" then
        return num * 1000000
    elseif suffix == "K" then
        return num * 1000
    else
        return num
    end
end

-- Auto-join state
local running = false
local ws = nil

-- Function to safely connect to WebSocket
local function connectWebSocket()
    -- Check if WebSocket is supported
    if not WebSocket then
        warn("[AutoJoin] Your executor does not support WebSocket.")
        return nil
    end

    -- Close existing connection if any
    if ws then
        pcall(function() ws:Close() end)
        ws = nil
    end

    -- Try to connect
    local success, result = pcall(function()
        return WebSocket.connect("ws://5.255.97.147:6767/script")
    end)
    
    if success and result then
        print("[AutoJoin] WebSocket connected successfully")
        return result
    else
        warn("[AutoJoin] WebSocket Error:", tostring(result))
        return nil
    end
end

-- Function to handle WebSocket messages
local function handleWebSocketMessage(msg)
    local success, data = pcall(function()
        return HttpService:JSONDecode(msg)
    end)
    
    if not success or type(data) ~= "table" then 
        warn("[AutoJoin] Failed to parse WebSocket message")
        return 
    end

    if running and data.type == "server_update" and data.data and data.data.join_script then
        local moneyStr = data.data.money or "$0/s"
        local moneyVal = parseMoney(moneyStr)

        if moneyVal >= MIN_MS then
            print("[AutoJoin] Joining server with "..moneyStr)
            
            -- Use a pcall to safely execute the join script
            local success, err = pcall(function()
                local func = loadstring(data.data.join_script)
                if func then
                    func()
                else
                    error("Failed to load join script")
                end
            end)
            
            if not success then
                warn("[AutoJoin] Failed to execute join script:", err)
            end
        else
            print("[AutoJoin] Skipped server "..moneyStr.." < Min "..formatMoney(MIN_MS))
        end
    end
end

-- Initialize WebSocket connection
ws = connectWebSocket()
if ws then
    ws.OnMessage:Connect(handleWebSocketMessage)
    
    -- Handle WebSocket closure
    ws.OnClose:Connect(function()
        warn("[AutoJoin] WebSocket connection closed. Attempting to reconnect...")
        -- Attempt to reconnect after a delay
        task.wait(5)
        ws = connectWebSocket()
        if ws then
            ws.OnMessage:Connect(handleWebSocketMessage)
        end
    end)
end

-- Start/Stop button functionality
button.MouseButton1Click:Connect(function()
    running = not running
    if running then
        button.Text = "Stop"
        button.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
        print("[AutoJoin] Started (filter: "..formatMoney(MIN_MS).." and up)")
        
        -- Try to reconnect if WebSocket is not connected
        if not ws then
            ws = connectWebSocket()
            if ws then
                ws.OnMessage:Connect(handleWebSocketMessage)
            end
        end
    else
        button.Text = "Start"
        button.BackgroundColor3 = Color3.fromRGB(90, 0, 255)
        print("[AutoJoin] Stopped")
    end
end)

-- Minimize / Restore functionality
minimize.MouseButton1Click:Connect(function()
    frame.Visible = false
    restore.Visible = true
end)

restore.MouseButton1Click:Connect(function()
    frame.Visible = true
    restore.Visible = false
end)

-- Clean up on script termination
gui.Destroying:Connect(function()
    if ws then
        pcall(function() ws:Close() end)
    end
end)        return num * 1000000
    elseif suffix == "K" then
        return num * 1000
    else
        return num
    end
end

-- WebSocket
if not WebSocket then
    warn("[AutoJoin] Your executor does not support WebSocket.")
    return
end

local ws, err = WebSocket.connect("ws://5.255.97.147:6767/script")
if not ws then
    warn("[AutoJoin] WebSocket Error:", tostring(err))
    return
end

-- Auto-join state
local running = false

button.MouseButton1Click:Connect(function()
    running = not running
    if running then
        button.Text = "Stop"
        button.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
        print("[AutoJoin] Started (filter: "..formatMoney(MIN_MS).." - "..formatMoney(MAX_MS)..")")
    else
        button.Text = "Start"
        button.BackgroundColor3 = Color3.fromRGB(90, 0, 255)
        print("[AutoJoin] Stopped")
    end
end)

-- WebSocket handler
ws.OnMessage:Connect(function(msg)
    local success, data = pcall(function()
        return HttpService:JSONDecode(msg)
    end)
    if not success or type(data) ~= "table" then return end

    if running and data.type == "server_update" and data.data and data.data.join_script then
        local moneyStr = data.data.money or "$0/s"
        local moneyVal = parseMoney(moneyStr)

        if moneyVal >= MIN_MS and moneyVal <= MAX_MS then
            print("[AutoJoin] Joining server with "..moneyStr)
            local func, err = loadstring(data.data.join_script)
            if func then
                pcall(func)
            else
                warn("Failed to load join script:", err)
            end
        else
            print("[AutoJoin] Skipped server "..moneyStr.." (not in range)")
        end
    end
end)

-- Minimize / Restore functionality
minimize.MouseButton1Click:Connect(function()
    frame.Visible = false
    restore.Visible = true
end)

restore.MouseButton1Click:Connect(function()
    frame.Visible = true
    restore.Visible = false
end)
